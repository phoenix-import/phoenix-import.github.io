<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Fumbled order fixer 2025 XL edition</title>
<style>
 body{font-family:system-ui,sans-serif;margin:2rem;max-width:42rem;}
 input[type=file]{margin:1rem 0;}
 #log{color:crimson;white-space:pre-wrap;}
</style>
</head>
<body>

<h1>Fumbled order fixer 2025 XL edition</h1>

<input type="file" id="file" accept=".txt">
<button id="go">Convert</button>
<p id="log"></p>

<script>
const log = m => document.getElementById('log').textContent = m;

function parseEuro(str){
  return parseFloat(str.replace(/[â‚¬ \s]/g,'').replace(',','.')) || 0;
}

document.getElementById('go').onclick = async ()=>{
  const f = document.getElementById('file').files[0];
  if(!f){log('Choose a file first.');return;}
  const raw = await f.text();

  // Normalise: remove exotic spaces, collapse multiple blank lines
  const lines = raw.replace(/\u202f/g,' ').split(/\r?\n/).map(l=>l.trim());
  const clean = lines.filter(l=>l.length>0);   // drop empties

  const rows = [['prod_code','unit_code','qty']];
  // Each block: [title, code, unit, stock, total]
  for(let i=0;i<clean.length;i+=5){
    const code  = clean[i+1] || '';
    const unit  = parseEuro(clean[i+2]);
    const total = parseEuro(clean[i+4]);
    const qty   = unit>0 && total>0 ? Math.round(total/unit) : '';
    if(code && qty) rows.push([code,'',qty]);
  }

  const csv = rows.map(r=>r.join(';')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
  const a = Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(blob),
    download:`weirdorder_${today}.csv`
  });
  a.click();
  URL.revokeObjectURL(a.href);
  log(`Done. ${rows.length-1} records written.`);
};
</script>
</body>
</html>
