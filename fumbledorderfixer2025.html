<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Weird order → CSV</title>
<style>
 body {font-family: system-ui, sans-serif; margin:2rem; max-width:42rem;}
 input[type=file]{margin:1rem 0;}
 #log{color:crimson;white-space:pre-wrap;}
</style>
</head>
<body>

<h1>Weird order → CSV converter</h1>

<input type="file" id="file" accept=".txt">
<button id="go">Convert</button>
<p id="log"></p>

<script>
const log = msg => document.getElementById('log').textContent = msg;

// normalise decimal formats
function parseEuro(str){
  if(!str) return NaN;
  return parseFloat(str.replace(/[€ \s]/g,'').replace(',','.'));
}

document.getElementById('go').onclick = async ()=>{
  const f = document.getElementById('file').files[0];
  if(!f){log('Choose a file first.');return;}
  const raw = await f.text();

  // normalise weird Unicode spaces and linebreaks
  const text = raw.replace(/\u202f/g,' ').replace(/\r/g,'');
  const lines = text.split('\n').map(l=>l.trim()).filter(l=>l.length);

  const euroRe = /^€\s*([\d.,]+)/;
  const codeRe = /^[A-Za-z0-9/]+$/;

  const rows = [['prod_code','unit_code','qty']];
  let code=null, unit=null, total=null;

  for(const line of lines){
    // code line
    if(codeRe.test(line)){
      code = line;
      unit = total = null;
      continue;
    }

    const m = line.match(euroRe);
    if(m){
      const val = parseEuro(m[0]);
      if(!unit) unit = val;
      else if(!total){
        total = val;
        if(code && unit && total){
          const qty = Math.round(total/unit);
          if(qty>0){
            rows.push([code,'',qty]);
          }
          code = unit = total = null;
        }
      }
    }
  }

  const csv = rows.map(r=>r.join(';')).join('\r\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const today = new Date().toISOString().slice(0,10).replace(/-/g,'');
  const a = Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(blob),
    download:`weirdorder_${today}.csv`
  });
  a.click();
  URL.revokeObjectURL(a.href);
  log(`Done. ${rows.length-1} records written.`);
};
</script>
</body>
</html>
